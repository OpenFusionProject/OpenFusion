$versions = "104", "728", "1013"

foreach ($version in $versions) {
    Write-Output "Cleaning old output"
    Invoke-Expression "make clean"
    if ($LASTEXITCODE -ne "0") {
        Write-Error "make clean failed for version $version" -ErrorAction Stop
    }
    Write-Output "Building version $version"
    Invoke-Expression "make -j8 PROTOCOL_VERSION=$version"
    if ($LASTEXITCODE -ne "0") {
        Write-Error "make failed for version $version" -ErrorAction Stop
    }
    Rename-Item -Path "bin/fusion" -newName "$version-fusion"
    Write-Output "Built version $version"
}
Copy-Item -Path "sql" -Destination "bin/sql" -Recurse
Copy-Item -Path "config.ini" -Destination "bin"